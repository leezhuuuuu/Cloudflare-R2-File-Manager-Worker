<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare R2 文件管理器</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #auth-container { margin-bottom: 20px; }
        #auth-container input { margin-right: 10px; }
        #file-management { display: none; } /* Initially hidden */
        #file-list { border: 1px solid #ccc; padding: 10px; min-height: 100px; margin-bottom: 20px; }
        .file-item { margin-bottom: 5px; padding: 5px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
        .file-item button { margin-left: 10px; }
        #upload-form { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Cloudflare R2 文件管理器</h1>

    <div id="auth-container">
        <label for="password">密码:</label>
        <input type="password" id="password" name="password">
        <button id="login-button">登录</button>
        <p id="auth-status"></p>
    </div>

    <div id="file-management">
        <h2>文件列表</h2>
        <div id="file-list">
            加载中...
        </div>

        <h2>上传文件</h2>
        <form id="upload-form">
            <input type="file" id="file-input" required>
            <button type="submit">上传</button>
        </form>
    </div>

    <script>
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const authStatus = document.getElementById('auth-status');
        const fileManagementDiv = document.getElementById('file-management');
        const fileListDiv = document.getElementById('file-list');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');

        let currentPassword = ''; // Store password temporarily

        // Function to make authenticated requests
        async function makeAuthenticatedRequest(url, options = {}) {
            const headers = new Headers(options.headers);
            if (currentPassword) {
                headers.set('X-Custom-Auth-Key', currentPassword);
            }
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                authStatus.textContent = '认证失败，请检查密码。';
                fileManagementDiv.style.display = 'none';
                currentPassword = ''; // Clear password on auth failure
                return null; // Indicate failure
            }
            return response;
        }

        // Function to fetch and display file list
        async function fetchFileList() {
            fileListDiv.innerHTML = '加载中...';
            const response = await makeAuthenticatedRequest('/'); // GET request to root path lists files
            if (!response) return; // Stop if authentication failed

            const files = await response.json();
            fileListDiv.innerHTML = ''; // Clear loading message

            if (files.length === 0) {
                fileListDiv.textContent = '存储桶中没有文件。';
                return;
            }

            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.classList.add('file-item');
                fileItem.innerHTML = `
                    <span>${file.key} (大小: ${file.size} 字节)</span>
                    <div>
                        <button class="download-button" data-key="${file.key}">下载</button>
                        <button class="delete-button" data-key="${file.key}">删除</button>
                    </div>
                `;
                fileListDiv.appendChild(fileItem);
            });

            // Add event listeners for download and delete buttons
            fileListDiv.querySelectorAll('.download-button').forEach(button => {
                button.addEventListener('click', handleDownload);
            });
            fileListDiv.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
        }

        // Handle login button click
        loginButton.addEventListener('click', async () => {
            const password = passwordInput.value;
            if (!password) {
                authStatus.textContent = '请输入密码。';
                return;
            }
            currentPassword = password;

            // Attempt to fetch file list to verify password
            const response = await makeAuthenticatedRequest('/');
            if (response) {
                authStatus.textContent = '登录成功！';
                fileManagementDiv.style.display = 'block';
                fetchFileList(); // Load files after successful login
            }
        });

        // Handle file download
        async function handleDownload(event) {
            const key = event.target.dataset.key;
            const response = await makeAuthenticatedRequest(`/${key}`); // GET request for specific file
             if (!response) return;

            // Create a blob from the response and create a download link
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = key.split('/').pop(); // Suggest filename from key
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url); // Clean up
        }

        // Handle file delete
        async function handleDelete(event) {
            const key = event.target.dataset.key;
            if (confirm(`确定要删除文件 "${key}" 吗？`)) {
                const response = await makeAuthenticatedRequest(`/${key}`, { method: 'DELETE' });
                if (response) {
                    alert(`文件 "${key}" 删除成功！`);
                    fetchFileList(); // Refresh list
                }
            }
        }

        // Handle file upload form submission
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const file = fileInput.files[0];
            if (!file) {
                alert('请选择要上传的文件。');
                return;
            }

            const key = file.name; // Use original file name as R2 key
            const response = await makeAuthenticatedRequest(`/${key}`, {
                method: 'PUT',
                body: file, // File object can be used directly as body
                // Optional: Set Content-Type based on file type
                 headers: { 'Content-Type': file.type || 'application/octet-stream' }
            });

            if (response) {
                alert(`文件 "${key}" 上传成功！`);
                fileInput.value = ''; // Clear input
                fetchFileList(); // Refresh list
            }
        });

         // Allow logging in by pressing Enter in the password field
         passwordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                loginButton.click(); // Trigger login button click
            }
        });

    </script>
</body>
</html>